<!DOCTYPE html>
<html>
    <head>
        <meta name="format-detection" content="telephone=no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
      <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
       <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
      <link href="https://zurb.com/playground/uploads/upload/upload/430/tribute.css">

        <title>Test</title>
      <style>
        html,body{background-color:white
          -webkit-user-select: none; 
          -moz-user-select: none;     
          -ms-user-select: none;
          user-select: none;  
        }
        .hl{
        background-color:yellow;
        }
        #text span{cursor:pointer}
      </style>
  </head>
  <body class="white">
    <a class="btn green" onclick="storesel()">add fact</a>
    <div class="container">
      <div id="status" class="hide"></div>
      <div class="row">
        <div class="col s8" id="text">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse dapibus interdum nibh tincidunt tempor. Integer auctor justo eu leo varius, in rutrum diam egestas. Sed lacinia erat elit, at pellentesque sapien feugiat at. Aliquam non porttitor arcu. Aliquam scelerisque lorem vitae massa pellentesque, sit amet efficitur orci imperdiet. Proin a dui purus. Mauris consectetur odio eu nunc sodales bibendum.

Aenean vitae odio felis. Suspendisse quis consequat velit, vitae sagittis sapien. Donec felis sem, accumsan ut ullamcorper eu, luctus vitae massa. Nullam ullamcorper pulvinar ante ut vestibulum. Cras elit dolor, vestibulum et lacus a, egestas pellentesque nunc. Suspendisse a nisi commodo quam congue tincidunt et quis diam. Nam dictum leo pharetra vestibulum consectetur.

Maecenas quis odio quis ante viverra consequat. Donec consectetur tortor odio, nec viverra dolor ultrices a. Nulla facilisi. Quisque tortor massa, placerat sit amet tortor at, pretium ultrices lectus. Donec sit amet dapibus diam. Pellentesque purus mauris, efficitur at facilisis non, sagittis vitae ligula. Donec posuere velit ut justo viverra volutpat. Nulla vitae feugiat ex.

Fusce consequat libero ac egestas varius. Nam tincidunt eget ipsum sed consequat. Aliquam erat volutpat. Morbi pretium justo mi, eu consectetur justo vestibulum et. Fusce ornare enim ac quam ultricies, a aliquam magna consequat. Mauris cursus imperdiet mi sed luctus. Donec a condimentum velit, a maximus sapien. Integer hendrerit est eget mollis tristique. Nunc massa dui, sagittis ac velit efficitur, aliquam tempus ipsum. Donec sed metus at ex iaculis mattis id nec mi. Etiam id ex pulvinar nunc lacinia posuere eu tincidunt ipsum.

Vivamus in bibendum lorem. Nullam eget facilisis arcu. Sed egestas, tellus in porttitor molestie, diam eros pretium mi, vitae fringilla quam est ut nunc. Pellentesque placerat, odio ut tincidunt cursus, turpis enim facilisis nisl, sit amet eleifend urna velit nec lacus. Vestibulum eleifend rhoncus dolor eget mollis. Phasellus ornare lacus vitae dui posuere rutrum. Donec ut pulvinar metus, eu commodo eros. Duis a ante laoreet diam bibendum facilisis. Morbi semper, leo sed semper mattis, nisl nulla elementum quam, sed cursus urna metus ac ipsum. Aliquam blandit posuere lorem sed porta. Donec finibus eleifend lectus nec efficitur. Ut maximus sagittis ipsum, sit amet feugiat sapien. Fusce elementum orci et aliquam malesuada. Class aptent taciti sociosqu ad litora torquent per conubia nostra, per inceptos himenaeos. Nunc aliquet eros quis nulla condimentum, sed mollis sem bibendum.
        </div>
        <div class="col s4" id="comments"></div>
      </div>
    </div>
    
    <script>var pg = false;</script>
    <script type="text/javascript" charset="utf-8" src="cordova.js" id="cordova" onload="pg=true;"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
    <script src="https://zurb.com/playground/uploads/upload/upload/435/tribute.js"></script>
    <script type="text/javascript">
      var tribute;
      $(document).ready(function(){
        $('#status').prepend('document ready<br>');
       if(pg===true){
         $('#status').prepend('phonegap<br>');
         $(document).on('deviceready', onDeviceReady);
       }
        else{
        $('#status').prepend('not phonegap<br>');
          init();
        }
      });
      
      function onDeviceReady() {    
        $('#status').prepend('device ready<br>');
        init()
      } 
      
      var db = {
        settings:{},
        facts:{},
        people:{}
      }
      
      var factnum = 0;
      
      var thisfact = {
        segments:{},
        id:'',
        comment:''
      };
      
      
      
      var down = false;
      
      function init(){
         tribute = new Tribute({
           collection: [{
             trigger: '@',
             fillAttr: 'value',
             selectTemplate: function (item) {
               return '@' + item.original.value;
             },
             values: [{key:'Marco',value:'marco'},{key:'Eva',value:'eva'}],
             allowSpaces: false
           },
            {
             trigger: '#',
             fillAttr: 'value',
              selectTemplate: function (item) {
               return '#' + item.original.value;
             },
             values: [{key:'Light issue',value:'light'},{key:'Heavy issue',value:'heavy'}],
             allowSpaces: false
           }
                       ]
         });          
        
        var html = '<span>'
        +$('#text').text()
        .replace(/\./g,'.</span><span>')
        .replace(/,/g,',</span><span>')
        .replace(/:/g,':</span><span>')
       .replace(/\n/g,'\n</span><span>')
        .replace(/;/g,';</span><span>')
        .replace(/!/g,'!</span><span>')
        .replace(/\?/g,'?</span><span>')
        .replace(/'/g,"'</span><span>")
       .replace(/"/g,'"</span><span>')
        +'</span>';
        
        $('#text').html(html);
        
        $(document).mousedown(function(){down=true});
        $(document).mouseup(function(){down=false});
        var num = 1;
        $('#text span').each(function(){
        $(this).attr('id',num);
          $(this).mouseover(function(){        if(down){hl($(this))}        });
          $(this).click(function(){       hl($(this))        });
          num++;
        });
      }
      
      function hl(dis){
        dis.toggleClass('hl');
        var id = dis.attr('id');
        if(thisfact['segments'][id]===undefined){thisfact['segments'][id]=dis.text()}
        else{delete thisfact['segments'][id]}
      }
      
      function storesel(){
        if(Object.keys(thisfact['segments']).length>0){
      db['facts'][factnum]=thisfact;
      factnum++;
        thisfact={
          segments:{},
          id:'',
          comment:''
      };
        $('.hl').removeClass('hl');
          Materialize.toast('fact stored',2000)
        console.log(db);
       displayfacts();
        }else{
        Materialize.toast('facts without reference do not count',2000);
        }
      }
      
      function displayfacts(){
        $('#comments').html('')
      var fac = db.facts;

        for (var t in fac){
          var html = '';
          var selector = '';
          for (var g in fac[t]['segments']){
          selector+='#'+g+' ,'
          }
          selector=selector.slice(0,-2)
        html+='<div class="card green lighten-2" id="fact'+t+'" onmouseover="$(\''+selector+'\').addClass(\'green\')" onmouseout="$(\''+selector+'\').removeClass(\'green\')" onload="$(this).focus()" onkeyup="db.facts[\''+t+'\'][\'comment\']=$(this).text()">'+fac[t].comment+'</div>';
          $('#comments').append(html);
          tribute.attach(document.getElementById('fact'+t));
          document.getElementById('fact'+t).addEventListener('tribute-no-match', function (e) {  console.log(e);console.log(tribute)});
          document.getElementById('fact'+t).addEventListener('tribute-replaced', function (e) { console.log(e);});
        }
        
      }

      </script> 
    </body>
</html>
