<!DOCTYPE html>
<html>
    <head>
        <meta name="format-detection" content="telephone=no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
      <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
       <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
      <link href="https://bgrins.github.io/spectrum/spectrum.css">

        <title>Test</title>
      <style>
        html,body{background-color:white
          -webkit-user-select: none; 
          -moz-user-select: none;     
          -ms-user-select: none;
          user-select: none;  
        }
        .hl{
        background-color:yellow;
        }
        #text span{cursor:pointer}
      </style>
  </head>
  <body class="white">
    <a class="btn green" onclick="storesel()">add selection</a>
    <div class="container">
      <div id="status"></div>
      <div class="row">
        <div class="col s11" id="text">
        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Duo Reges: constructio interrete. Quae est igitur causa istarum angustiarum? Nunc vero a primo quidem mirabiliter occulta natura est nec perspici nec cognosci potest. Qui potest igitur habitare in beata vita summi mali metus? At quicum ioca seria, ut dicitur, quicum arcana, quicum occulta omnia? Consequentia exquirere, quoad sit id, quod volumus, effectum.
        </div>
        <div class="col s1" id="comments"></div>
      </div>
    </div>
    
    <script>var pg = false;</script>
    <script type="text/javascript" charset="utf-8" src="cordova.js" id="cordova" onload="pg=true;"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
       $('#status').prepend('document ready<br>');
       if(pg===true){
         $('#status').prepend('phonegap<br>');
         $(document).on('deviceready', onDeviceReady);
       }
        else{
        $('#status').prepend('not phonegap<br>');
          init();
        }
      });
      
      function onDeviceReady() {    
        $('#status').prepend('device ready<br>');
        init()
      } 
      
      var db = {
        settings:{},
        facts:{}
      }
      
      var factnum = 0;
      
      var thisfact = {
        segments:{},
        comment:'',
        id:''
      };
      var down = false;
      
      function init(){
        var html = '<span>'
        +$('#text').text()
        .replace(/\./g,'.</span><span>')
        .replace(/,/g,',</span><span>')
        .replace(/:/g,':</span><span>')
       .replace(/\n/g,'\n</span><span>')
        .replace(/;/g,';</span><span>')
        .replace(/!/g,'!</span><span>')
        .replace(/\?/g,'?</span><span>')
        .replace(/'/g,"'</span><span>")
       .replace(/"/g,'"</span><span>')
        +'</span>';
        
        $('#text').html(html);
        
        $(document).mousedown(function(){down=true});
        $(document).mouseup(function(){down=false});
        var num = 1;
        $('#text span').each(function(){
        $(this).attr('id',num);
          $(this).mouseover(function(){        if(down){hl($(this))}        });
          $(this).click(function(){       hl($(this))        });
          num++;
        });
      }
      
      function hl(dis){
        console.log(dis);
        dis.toggleClass('hl');
        var id = dis.attr('id');
        if(thisfact['segments'][id]===undefined){thisfact['segments'][id]=dis.text()}
        else{delete thisfact['segments'][id]}
        console.log(thisfact)
      }
      
      function storesel(){
        console.log(Object.keys(thisfact['segments']).length);
        if(Object.keys(thisfact['segments']).length>0){
        thisfact['comment']=prompt('comment');
      db['facts'][factnum]=thisfact;
      factnum++;
        thisfact={
        segments:{},
        comment:'',
        id:''
      };
        $('.hl').removeClass('hl');
          Materialize.toast('fact stored',2000)
        console.log(db);
       displayfacts();
        }else{
        Materialize.toast('facts without reference do not count',2000);
        }
      }
      
      function displayfacts(){
      var fac = db.facts;
        var html = '';
        for (var t in fac){
          var selector = '';
          for (var g in fac[t]['segments']){
          selector+='#'+g+' ,'
          }
          selector=selector.slice(0,-2);console.log(selector);
        html+='<div class="card green lighten-2" id="fact'+t+'" onmouseover="$(\''+selector+'\').addClass(\'green\')" onmouseout="$(\''+selector+'\').removeClass(\'green\')" >'+fac[t].comment+'</div>';
        }
        $('#comments').html(html)
      }

      </script> 
    </body>
</html>
