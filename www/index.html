<!DOCTYPE html>
<html>
    <head>
        <meta name="format-detection" content="telephone=no">
        <meta name="msapplication-tap-highlight" content="no">
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width">
      <link href="http://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
       <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/css/materialize.min.css">
      <link href="https://bgrins.github.io/spectrum/spectrum.css">

        <title>Test</title>
      <style>
        html,body{background-color:white}
      </style>
  </head>
  <body class="white">
    <div class="container">
        <a class="btn green waves-effect hide" id="scan" onclick="blenable();"><i class="material-icons left">bluetooth_searching</i>scan</a>
        <div id="devices"></div>
      <div id="status"></div>
    </div>
    
    <div id="tempdevice" class="hide">
      <div class="card" id="NAME">
        <div class="card-title">NAME</div>
        <div class="card-content">
          <i>ID</i>
          <a class="btn blue waves-effect" id="connectbutNAME" onclick="$(this).addClass('disabled');connect('ID','NAME');"><i class="material-icons">bluetooth</i></a>
          <div id="servicesNAME">serivcesNAME</div>
        </div>
      </div>
    </div>
    
    <script type="text/javascript" charset="utf-8" src="cordova.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.8/js/materialize.min.js"></script>
    <script src="http://www.daviddurman.com/flexi-color-picker/js/colorpicker.min.js"></script>
    <script type="text/javascript">
      $(document).ready(function(){
       $('#status').prepend('document ready<br>');
      document.addEventListener('deviceready', onDeviceReady);
      });
      
      function onDeviceReady() {    
        $('#status').prepend('device ready<br>');
        blenable();
      } 
    function scan(){
      $('#devices').html('');
    ble.scan([], 30, listdevices, failed)
    }
    
      function listdevices(device){
          var html = $('#tempdevice').html()
          .replace(/ID/g,device.id)
          .replace(/NAME/g,device.name.replace(/-/g,'0'))
        $('#devices').append(html)
      }    
      
    function blenable(){
      ble.enable(function() { $('#status').prepend("Bluetooth is enabled<br>"); $('#scan').removeClass('hide');scan(); },
                 function() { $('#status').prepend("The user did *not* enable Bluetooth<br>"); blenable()}
                );
    }  
      function failed(error){
      $('#status').prepend(JSON.stringify(error)+'<br>');
      }
      var sendcol ='';
      
      function connect(id,name){
        name = name.replace(/-/g,'0')
        $('#status').prepend('trying to connect to "'+name+'" ,id: '+id+'<br>');
        ble.connect(id,function(thisdevice){
          $('#status').prepend(JSON.stringify(thisdevice));
         $('#connectbut'+name).removeClass('disabled');
      $('#services'+name).html('<div id="picker'+name+'"></div><div id="slide'+name+'"></div>');
          ColorPicker(
            document.getElementById('slide'+name),
            document.getElementById('picker'+name),
            function(hex, hsv, rgb) {               
              if (sendcol!=hex){
                sendcol=hex; $('#status').prepend(hex+'<br>');
                var arra = ['56',hex.substr(1,2),hex.substr(3,2),hex.substr(5,2),'00','f0','aa'];
                var bf = new Uint8Array(arra.length);
                for (var y in arra){
                  bf[y]='0x'+arra[y]
                } 
                $('#status').prepend(bf+'<br>');
                write(id,bf.buffer);
        }
            });
      },failed)
      }
      
      function write(id,data){
        //0000ffe5-0000-1000-8000-00805f9b34fb
      ble.writeWithoutResponse(id,'ffe5','ffe9', data, function(resu){$('#status').prepend(resu+'<br>');}, failed);
      }
      </script> 
    </body>
</html>
